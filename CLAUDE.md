# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Budget Planner is an **offline-first Progressive Web App (PWA)** with a SvelteKit frontend and Go backend. The app focuses on personal budget management with monthly reflections, budget sharing, and offline synchronization.

### Tech Stack

**Frontend:** SvelteKit PWA + Shadcn-Svelte + Tailwind CSS + IndexedDB (offline storage)
**Backend:** Go 1.23 + Chi router + PostgreSQL + sqlc (ORM)
**Auth:** Clerk SDK
**Development:** Docker Compose devcontainer with PostgreSQL 16

---

## Quick Start

```bash
# Backend (in devcontainer)
cd backend && air                    # Hot reload server
cd backend && go test ./... -v       # Run tests

# Frontend
cd frontend && npm run dev           # Dev server on http://localhost:5173
cd frontend && npm run check         # Type checking
cd frontend && npm run build         # Production build

# Database
docker-compose up -d postgres        # Start PostgreSQL
```

---

## Architecture Overview

The application is designed to work offline using an **offline-first sync architecture**:

1. **Frontend** stores all data in IndexedDB for offline access
2. **Sync queue** captures changes when offline
3. **Sync API** (`/api/sync/push`, `/api/sync/pull`) handles bidirectional sync
4. **Conflict resolution** uses timestamp-based and owner-priority strategies

**See `backend/CLAUDE.md` and `frontend/CLAUDE.md` for detailed architecture patterns.**

---

## File Structure

```
budget-planner/
‚îú‚îÄ‚îÄ backend/              # Go API with Chi router
‚îÇ   ‚îú‚îÄ‚îÄ cmd/api/         # Main entry point
‚îÇ   ‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/    # HTTP handlers (10 handlers, 100% test coverage)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/      # Generated by sqlc
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/       # Type conversions
‚îÇ   ‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema/      # Database migrations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queries/     # SQL queries for sqlc
‚îÇ   ‚îî‚îÄ‚îÄ CLAUDE.md        # Backend development guide
‚îú‚îÄ‚îÄ frontend/            # SvelteKit PWA
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/         # Utilities, DB clients, stores
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/      # SvelteKit file-based routing
‚îÇ   ‚îú‚îÄ‚îÄ static/          # PWA assets
‚îÇ   ‚îî‚îÄ‚îÄ CLAUDE.md        # Frontend development guide
‚îú‚îÄ‚îÄ starting-point.md    # Full project specification
‚îî‚îÄ‚îÄ CLAUDE.md            # This file
```

---

## Key Reference Files

- **`starting-point.md`** - Complete project specification (database schema, API endpoints, workflows)
- **`backend/CLAUDE.md`** - Backend development patterns (sqlc, type conversions, testing)
- **`frontend/CLAUDE.md`** - Frontend development patterns (SvelteKit, IndexedDB, PWA)
- **`backend/todo.md`** - Backend implementation status
- **`frontend/todo.md`** - Frontend implementation status & TODO

---

## Current Status

**Backend:** ‚úÖ Complete (100% test coverage - 48/48 tests passing)
- All 10 handlers implemented and tested
- JWT-based authentication (Clerk-compatible)
- sqlc for type-safe database queries

**Frontend:** ‚ö†Ô∏è ~75% Complete
- Core pages implemented (Budget Overview, Expense Tracker, Bill Payment)
- Transaction Modal with form validation
- IndexedDB client and sync queue infrastructure
- ‚ö†Ô∏è **Needs:** Backend API integration, month navigation, settings page

---

## Environment Configuration

### Backend (.env)
```bash
DATABASE_URL=postgresql://budgetuser:budgetpass@postgres:5432/budgetdb?sslmode=disable
PORT=8080
CLERK_SECRET_KEY=your_clerk_secret_key
CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

### Frontend (.env)
```bash
PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
PUBLIC_API_URL=http://localhost:8080/api
```

**See `backend/CLAUDE.md` or `frontend/CLAUDE.md` for complete configuration details.**

---

## Development Workflow

### Backend
```bash
cd backend
air                              # Hot reload (watches .go and .sql files)
/home/vscode/go/bin/sqlc generate  # Generate Go code from SQL queries
```

### Frontend
```bash
cd frontend
npm run dev                      # Vite dev server with HMR
npm run check:watch              # Watch mode for type checking
```

---

## Testing

**Backend:**
```bash
cd backend
DATABASE_URL="postgresql://budgetuser:budgetpass@localhost:5432/budgetdb?sslmode=disable" go test ./internal/handlers/ -v
```

**Frontend:**
```bash
cd frontend
npm run check                    # TypeScript type checking
npm run build                    # Production build
```

---

## Common Patterns

### Authentication
1. Frontend uses Clerk SDK for authentication
2. Backend validates JWT tokens via middleware
3. User context attached to requests
4. Clerk user ID stored in `users.clerk_user_id` for lookups

### Migrations
- Numbered migration files: `001_initial_schema.up.sql`
- Run: `migrate -path backend/sql/schema -database "$DATABASE_URL" up`

---

## Important Implementation Notes

- **sqlc query generation:** Write SQL in `.sql` files ‚Üí `sqlc generate` ‚Üí Go code in `internal/models/`
- **Type conversions:** Backend uses `pgtype` types - always use helpers from `internal/utils/types.go`
- **Chi router:** Use `chi.URLParam(r, "param")` for path parameters, not `r.PathValue()`
- **Offline-first:** Frontend uses IndexedDB (via `idb` library) for local data persistence
- **PWA:** Service worker registered on app load for offline functionality

---

## WRAP-UP Workflow

When you mention the keyword **"WRAP-UP"**, I will:

### 1. Log Progress to Nearest todo.md

**Determine "nearest" todo.md:**
- If working in `/workspace/budget-planner/backend/*` ‚Üí Update `backend/todo.md`
- If working in `/workspace/budget-planner/frontend/*` ‚Üí Update `frontend/todo.md`
- If working in root or ambiguous ‚Üí Update `backend/todo.md` (default)

**What to log:**
- **Session Summary:** What was accomplished in this session
- **Technical Debts:** Known issues, code that needs refactoring, temporary workarounds
- **Warnings:** Non-blocking issues that should be addressed
- **Workarounds:** Temporary solutions with notes on proper implementation needed
- **Files Modified:** List of all files changed in this session

**Format (match existing todo.md style):**
- Backend: Session-based with date, status badges (‚úÖ‚ö†Ô∏è‚ùå)
- Frontend: Priority-based (Priority 1-4) with effort estimates

### 2. Update Nearest CLAUDE.md (If Applicable)

**When to update:**
- New architectural patterns introduced
- New development workflow established
- Breaking changes to existing patterns
- New dependencies or major tech stack changes

**When NOT to update:**
- Routine bug fixes
- Feature implementations following existing patterns
- Test updates
- Documentation improvements

### 3. Check .gitignore for Security Files

**Verify these patterns are in .gitignore:**
- `.env*` (all environment files)
- `*.key`, `*.pem`, `*.crt`, `*.p12`, `*.pfx` (certificates/keys)
- `secrets/`, `config/secrets/`, `auth/secrets/` (secrets directories)
- `credentials.json`, `auth.json`, `credentials.yaml` (credentials files)
- `*_secret`, `*.secret` (files with "secret" in name)
- `clerk_*.key` (Clerk-specific keys)
- `.env.production` (production environment)

**Check for files created during session:**
- Any `.env` files created
- Any API key files generated
- Any certificate/key files created
- Any credential files generated

### 4. Commit and Push Changes

**Commit message format:**
```
feat/fix/docs: brief description

- Detailed change 1
- Detailed change 2
- Technical debt: [if applicable]
- Workaround: [if applicable]

Co-authored-by: Claude Sonnet <noreply@anthropic.com>
```

**Steps:**
1. `git add` all changed files
2. Show brief summary: files changed + commit message
3. `git commit` with meaningful message
4. `git push` to current branch
5. Display commit SHA for reference

**Note:** This will be automatic after showing the summary (no confirmation needed per user preference).

---

### Example WRAP-UP Session

**User says:** "WRAP-UP"

**I will:**

1. **Identify context:** "You were working in `frontend/src/routes/transactions/`"

2. **Log to `frontend/todo.md`:**
   ```markdown
   ## Session: Transaction Modal Implementation (2025-12-27)

   ### Completed ‚úÖ
   - [x] AddExpenseModal component with 8 form fields
   - [x] Form validation with inline error messages
   - [x] Budget auto-creation functionality
   - [x] FAB button integration

   ### Technical Debts ‚ö†Ô∏è
   - Shadcn-Svelte CLI unavailable (requires TTY) - components created manually
   - bits-ui Dialog had type issues - created CustomModal instead
   - Simplified type definitions to avoid svelte/elements import conflicts

   ### Workarounds üîß
   - Manual component creation instead of CLI
   - CustomModal instead of bits-ui Dialog
   - Simplified types (less type-safe but functional)

   ### Files Modified
   - frontend/src/routes/transactions/AddExpenseModal.svelte
   - frontend/src/lib/components/ui/CustomModal.svelte
   - frontend/src/lib/stores/budgets.ts

   ### Next Steps
   - Backend API integration
   - Month navigation
   - Mark bill paid functionality
   ```

3. **Check `frontend/CLAUDE.md`:** No update needed (following existing patterns)

4. **Verify `.gitignore`:**
   - ‚úÖ `.env` already ignored
   - ‚úÖ `*.key` already ignored
   - ‚úÖ No new security files created

5. **Commit and push:**
   ```bash
   git add frontend/src/routes/transactions/AddExpenseModal.svelte
   git commit -m "feat(frontend): implement Transaction Modal with form validation"
   git push origin iteration/1
   ```

---

### Important Notes

**Context Detection:**
- I will use the most recently modified files to determine the "nearest" todo.md
- If ambiguous, I will ask you to clarify which todo.md to update

**What to Include in todo.md:**

*Technical Debts:*
- Code that needs refactoring
- Performance issues identified
- Security concerns (non-critical)
- Missing error handling
- Hardcoded values that should be configurable

*Warnings:*
- Deprecated patterns used
- Temporary solutions with expiration
- Known bugs that don't block functionality
- Accessibility issues (non-blocking)

*Workarounds:*
- Temporary fixes with proper solution noted
- Third-party library limitations and workarounds
- Development vs production differences
- Missing features and their temporary replacements

**Security Checks - Always verify:**
- No `.env` files committed
- No API keys in code
- No certificates/keys in repository
- No credentials in config files
- Production secrets not in dev commits
