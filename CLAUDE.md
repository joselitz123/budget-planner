# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Budget Planner is an **offline-first Progressive Web App (PWA)** with a SvelteKit frontend and Go backend. The app focuses on personal budget management with monthly reflections, budget sharing, and offline synchronization.

### Tech Stack

**Frontend:** SvelteKit PWA + Shadcn-Svelte + Tailwind CSS + IndexedDB (offline storage)
**Backend:** Go 1.23 + Chi router + PostgreSQL + sqlc (ORM)
**Auth:** Clerk SDK
**Development:** Docker Compose devcontainer with PostgreSQL 16

---

## Common Development Commands

### Backend (Go)

```bash
cd backend

# Run with hot reload (Air)
air

# Generate Go code from SQL queries (sqlc)
sqlc generate

# Run database migrations
migrate -path sql/schema -database "$DATABASE_URL" up

# Build
go build -o ./tmp/main ./cmd/api

# Run tests
go test ./...

# Lint
golangci-lint run --fast
```

### Frontend (SvelteKit)

```bash
cd frontend

# Install dependencies
npm install

# Run dev server
npm run dev

# Build for production
npm run build

# Type checking
npm run check
npm run check:watch

# Linting and formatting
npm run lint
npm run format
```

### Database

```bash
# Access PostgreSQL via psql (in devcontainer)
psql -h postgres -U budgetuser -d budgetdb

# Run migration
migrate -path backend/sql/schema -database "postgres://budgetuser:budgetpass@postgres:5432/budgetdb?sslmode=disable" up
```

---

## Architecture

### Offline-First Sync Architecture

The application is designed to work offline. Data flows between frontend IndexedDB and backend PostgreSQL:

1. **Frontend** stores all data in IndexedDB for offline access
2. **Sync queue** captures changes when offline
3. **Sync API** (`/api/sync/push`, `/api/sync/pull`) handles bidirectional sync
4. **Conflict resolution** uses timestamp-based and owner-priority strategies
5. **sync_operations table** tracks pending operations on the server

### Database Schema Pattern

All tables follow these conventions:
- `id UUID PRIMARY KEY DEFAULT gen_random_uuid()` - UUID primary keys
- `user_id UUID REFERENCES users(id) ON DELETE CASCADE` - User ownership
- `created_at TIMESTAMPTZ DEFAULT NOW()` - Audit timestamps
- `updated_at TIMESTAMPTZ DEFAULT NOW()` - Audit timestamps
- `deleted BOOLEAN DEFAULT FALSE` - Soft deletes (never hard delete)

### Code Organization with sqlc

**Key Pattern:** SQL queries are written in `.sql` files in `backend/sql/queries/`, then Go code is generated via `sqlc generate`.

Query naming convention:
```sql
-- name: GetUserByID :one
-- name: ListBudgets :many
-- name: CreateTransaction :exec
-- name: UpdateCategory :execrows
```

Generated code appears in `backend/internal/models/`:
- `models.go` - Struct definitions matching database tables
- `<table>.sql.go` - Query functions (e.g., `auth.sql.go`, `budgets.sql.go`)

**Always prefer using sqlc-generated queries over raw SQL in handlers.**

### Backend Structure

```
backend/
├── cmd/api/main.go          # Entry point, route registration
├── internal/
│   ├── auth/               # Clerk JWT verification, middleware
│   ├── config/             # Environment variable loading
│   ├── database/           # PostgreSQL connection pool
│   ├── handlers/           # HTTP request handlers (one file per domain)
│   ├── middleware/         # Chi middleware (auth, cors, logging)
│   ├── models/             # GENERATED by sqlc - do not edit
│   ├── sync/               # Offline sync queue processing
│   └── utils/              # Response helpers, etc.
├── sql/
│   ├── schema/             # Migration files (.up.sql, .down.sql)
│   └── queries/            # SQL queries for sqlc
├── sqlc.yaml               # sqlc configuration
└── .air.toml               # Air hot reload config
```

### Frontend Structure

```
frontend/
├── src/
│   ├── lib/                # Utility functions, DB clients
│   ├── routes/             # SvelteKit file-based routing
│   └── app.html            # HTML template
├── static/                 # PWA assets, icons
└── svelte.config.js        # Svelte configuration
```

---

## Key Implementation Notes

### Authentication Flow

1. Frontend uses Clerk SDK for authentication
2. Backend validates Clerk JWT tokens via middleware
3. User context is attached to requests by auth middleware
4. Clerk user ID is stored in `users.clerk_user_id` for lookups

### Permission Model for Sharing

Budgets can be shared with two permission levels:
- `view` - Read-only access
- `edit` - Full edit access

Permission checks occur in middleware/handlers via the `share_access` table. Always check:
1. Is user the owner? → Full access
2. Is user in share_access with edit permission? → Edit access
3. Is user in share_access with view permission? → Read-only
4. Otherwise → 404/403

### Migrations

The project uses numbered migration files (e.g., `001_initial_schema.up.sql`):
- Up migrations apply changes
- Down migrations roll back changes
- The init-db.sql in `.devcontainer/` contains the full initial schema

When adding migrations:
1. Create new file with next sequence number
2. Write both up and down versions
3. Test with `migrate up` and `migrate down`

### Hot Reload

- Backend uses Air (configured in `.air.toml`) - watches `.go` and `.sql` files
- Frontend uses Vite dev server - auto-reloads on save
- Running `sqlc generate` is manual - run after modifying `.sql` query files

---

## Environment Configuration

Required environment variables:

**Backend (.env):**
```
DATABASE_URL=postgresql://budgetuser:budgetpass@postgres:5432/budgetdb?sslmode=disable
PORT=8080
CLERK_SECRET_KEY=your_clerk_secret_key
CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

**Frontend (.env):**
```
PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
PUBLIC_API_URL=http://localhost:8080/api
```

---

## Important Files

- `starting-point.md` - Full project specification with database schema, API endpoints, and workflows
- `backend/TASK.md` - Backend development task log and progress tracker
- `AGENTS.md` - AI agent specifications for automation (reference for future development)
- `.devcontainer/SETUP_GUIDE.md` - Devcontainer setup details and troubleshooting
