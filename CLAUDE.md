# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Budget Planner is an **offline-first Progressive Web App (PWA)** with a SvelteKit frontend and Go backend. The app focuses on personal budget management with monthly reflections, budget sharing, and offline synchronization.

### Tech Stack

**Frontend:** SvelteKit PWA + Shadcn-Svelte + Tailwind CSS + IndexedDB (offline storage)
**Backend:** Go 1.23 + Chi router + PostgreSQL + sqlc (ORM)
**Auth:** Clerk SDK
**Development:** Docker Compose devcontainer with PostgreSQL 16

---

## Quick Start

```bash
# Backend (in devcontainer)
cd backend && air                    # Hot reload server
cd backend && go test ./... -v       # Run tests

# Frontend
cd frontend && npm run dev           # Dev server on http://localhost:5173
cd frontend && npm run check         # Type checking
cd frontend && npm run build         # Production build

# Database
docker-compose up -d postgres        # Start PostgreSQL
```

---

## Architecture Overview

The application is designed to work offline using an **offline-first sync architecture**:

1. **Frontend** stores all data in IndexedDB for offline access
2. **Sync queue** captures changes when offline
3. **Sync API** (`/api/sync/push`, `/api/sync/pull`) handles bidirectional sync
4. **Conflict resolution** uses timestamp-based and owner-priority strategies

**See `backend/CLAUDE.md` and `frontend/CLAUDE.md` for detailed architecture patterns.**

---

## File Structure

```
budget-planner/
├── backend/              # Go API with Chi router
│   ├── cmd/api/         # Main entry point
│   ├── internal/
│   │   ├── handlers/    # HTTP handlers (10 handlers, 100% test coverage)
│   │   ├── models/      # Generated by sqlc
│   │   └── utils/       # Type conversions
│   ├── sql/
│   │   ├── schema/      # Database migrations
│   │   └── queries/     # SQL queries for sqlc
│   └── CLAUDE.md        # Backend development guide
├── frontend/            # SvelteKit PWA
│   ├── src/
│   │   ├── lib/         # Utilities, DB clients, stores
│   │   └── routes/      # SvelteKit file-based routing
│   ├── static/          # PWA assets
│   └── CLAUDE.md        # Frontend development guide
├── starting-point.md    # Full project specification
└── CLAUDE.md            # This file
```

---

## Key Reference Files

- **`starting-point.md`** - Complete project specification (database schema, API endpoints, workflows)
- **`backend/CLAUDE.md`** - Backend development patterns (sqlc, type conversions, testing)
- **`frontend/CLAUDE.md`** - Frontend development patterns (SvelteKit, IndexedDB, PWA)
- **`backend/todo.md`** - Backend implementation status
- **`frontend/todo.md`** - Frontend implementation status & TODO

---

## Current Status

**Backend:** ✅ Complete (100% test coverage - 48/48 tests passing)
- All 10 handlers implemented and tested
- JWT-based authentication (Clerk-compatible)
- sqlc for type-safe database queries

**Frontend:** ⚠️ ~75% Complete
- Core pages implemented (Budget Overview, Expense Tracker, Bill Payment)
- Transaction Modal with form validation
- IndexedDB client and sync queue infrastructure
- ⚠️ **Needs:** Backend API integration, month navigation, settings page

---

## Environment Configuration

### Backend (.env)
```bash
DATABASE_URL=postgresql://budgetuser:budgetpass@postgres:5432/budgetdb?sslmode=disable
PORT=8080
CLERK_SECRET_KEY=your_clerk_secret_key
CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

### Frontend (.env)
```bash
PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
PUBLIC_API_URL=http://localhost:8080/api
```

**See `backend/CLAUDE.md` or `frontend/CLAUDE.md` for complete configuration details.**

---

## Development Workflow

### Backend
```bash
cd backend
air                              # Hot reload (watches .go and .sql files)
/home/vscode/go/bin/sqlc generate  # Generate Go code from SQL queries
```

### Frontend
```bash
cd frontend
npm run dev                      # Vite dev server with HMR
npm run check:watch              # Watch mode for type checking
```

---

## Testing

**Backend:**
```bash
cd backend
DATABASE_URL="postgresql://budgetuser:budgetpass@localhost:5432/budgetdb?sslmode=disable" go test ./internal/handlers/ -v
```

**Frontend:**
```bash
cd frontend
npm run check                    # TypeScript type checking
npm run build                    # Production build
```

---

## Common Patterns

### Authentication
1. Frontend uses Clerk SDK for authentication
2. Backend validates JWT tokens via middleware
3. User context attached to requests
4. Clerk user ID stored in `users.clerk_user_id` for lookups

### Migrations
- Numbered migration files: `001_initial_schema.up.sql`
- Run: `migrate -path backend/sql/schema -database "$DATABASE_URL" up`

---

## Important Implementation Notes

- **sqlc query generation:** Write SQL in `.sql` files → `sqlc generate` → Go code in `internal/models/`
- **Type conversions:** Backend uses `pgtype` types - always use helpers from `internal/utils/types.go`
- **Chi router:** Use `chi.URLParam(r, "param")` for path parameters, not `r.PathValue()`
- **Offline-first:** Frontend uses IndexedDB (via `idb` library) for local data persistence
- **PWA:** Service worker registered on app load for offline functionality

---

## WRAP-UP Workflow (Integrated with Beans)

When you mention the keyword **"WRAP-UP"**, I will:

### 0. Run Beans Prime (Automatic)

Run `beans prime` to automatically:
- Query recent work and context
- Prepare bean creation/update
- Track files modified in session
- Identify technical debts introduced

### 1. Create/Update Beans for Session Work

**For each feature/bug completed:**
- Create new bean or update existing open bean
- Set status to `completed` with completion date
- Add labels: `[completed]`, `[frontend|backend]`, feature area
- Populate `files_modified` list in bean body
- Add session date in bean body
- Link related beans (dependencies, blockers)

**For technical debts discovered:**
- Create `bug` type bean for technical debt
- Set priority (normal/low based on impact)
- Document problem and workaround used
- Add `files_modified` if applicable
- Add session date in bean body

**For bugs fixed:**
- Create `bug` type bean with status `completed`
- Document bug description and fix
- Link to feature bean if applicable

### 2. Update CLAUDE.md (If Applicable)

**When to update:**
- New architectural patterns introduced
- New development workflow established
- Breaking changes to existing patterns
- New dependencies or major tech stack changes

**When NOT to update:**
- Routine bug fixes
- Feature implementations following existing patterns
- Test updates
- Beans now tracks progress automatically

### 3. Check .gitignore for Security Files

**Verify these patterns are in .gitignore:**
- `.env*` (all environment files)
- `*.key`, `*.pem`, `*.crt`, `*.p12`, `*.pfx` (certificates/keys)
- `secrets/`, `config/secrets/`, `auth/secrets/` (secrets directories)
- `credentials.json`, `auth.json`, `credentials.yaml` (credentials files)
- `*_secret`, `*.secret` (files with "secret" in name)
- `clerk_*.key` (Clerk-specific keys)
- `.env.production` (production environment)

**Check for files created during session:**
- Any `.env` files created
- Any API key files generated
- Any certificate/key files created
- Any credential files generated

### 4. Commit and Push Changes

**Commit message format (enhanced with Beans):**
```
{type}: {title}

- Bean: {bean_id}
- Session: {session_date}
- Files: {files_modified}

Co-authored-by: Claude Sonnet <noreply@anthropic.com>
```

**Example:**
```
feat(frontend): implement month navigation

- Bean: BP-mfu9
- Session: 2025-12-28
- Files: frontend/src/routes/+layout.svelte, frontend/src/lib/stores/budgets.ts

- Implemented prev/next month buttons
- Updated currentMonth store
- Added data reload on month change

Co-authored-by: Claude Sonnet <noreply@anthropic.com>
```

**Steps:**
1. `beans prime` - Review beans created/updated
2. `git add` all changed files
3. Show brief summary: beans created/updated + files changed + commit message
4. `git commit` with bean-enhanced message
5. `git push` to current branch
6. Display commit SHA for reference

**Note:** This will be automatic after showing the summary (no confirmation needed per user preference).

---

### WRAP-UP Example Session

**User says:** "WRAP-UP"

**I will:**

1. **Run `beans prime`** and review beans:
   ```
   ✅ Created BP-mfu9: Month Navigation (feature, completed)
   ✅ Updated BP-577b: Shadcn CLI workaround (bug, notes added)
   ✅ Created BP-xxxx: Loading States Bug (bug, completed)
   ```

2. **Check context:** "You were working in `frontend/src/routes/+layout.svelte`"

3. **Verify `.gitignore`:**
   - ✅ `.env` already ignored
   - ✅ `*.key` already ignored
   - ✅ No new security files created

4. **Commit with bean metadata:**
   ```bash
   git add .
   git commit -m "feat(frontend): implement month navigation

   - Bean: BP-mfu9
   - Session: 2025-12-28

   Co-authored-by: Claude Sonnet <noreply@anthropic.com>"
   git push origin iteration/1
   ```

---

### Important Notes

**Bean Creation Rules:**

*When to create beans:*
- ✅ Every feature/bug fix/enhancement completed
- ✅ Every technical debt discovered
- ✅ Every testing task completed
- ✅ Every documentation update

*Bean metadata requirements:*
- `title` - Clear, actionable title
- `type` - One of: feature, bug, task, milestone, epic
- `status` - todo, in-progress, completed
- `priority` - critical, high, normal, low, deferred
- `tags` - At minimum: [frontend|backend], [feature-area]
- `body` - Include effort estimate, files modified, session date

*Technical Debt beans:*
- Always create when workaround used
- Include problem description
- Include workaround details
- Suggest proper solution if known
- Set priority based on impact

**Useful Beans Commands:**

```bash
# Show open beans by priority
beans list --status todo

# Show frontend tasks
beans list --tag frontend

# Show technical debts
beans list --tag tech-debt

# Start working on a bean
beans update <bean-id> --status in-progress

# Complete a bean
beans update <bean-id> --status completed

# Archive old beans
beans archive
```

**Security Checks - Always verify:**
- No `.env` files committed
- No API keys in code
- No certificates/keys in repository
- No credentials in config files
- Production secrets not in dev commits
