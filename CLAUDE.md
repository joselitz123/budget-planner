# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Budget Planner is an **offline-first Progressive Web App (PWA)** with a SvelteKit frontend and Go backend. The app focuses on personal budget management with monthly reflections, budget sharing, and offline synchronization.

### Tech Stack

**Frontend:** SvelteKit PWA + Shadcn-Svelte + Tailwind CSS + IndexedDB (offline storage)
**Backend:** Go 1.23 + Chi router + PostgreSQL + sqlc (ORM)
**Auth:** Clerk SDK
**Development:** Docker Compose devcontainer with PostgreSQL 16

---

## Quick Start

```bash
# Backend (in devcontainer)
cd backend && air                    # Hot reload server
cd backend && go test ./... -v       # Run tests

# Frontend
cd frontend && npm run dev           # Dev server on http://localhost:5173
cd frontend && npm run check         # Type checking
cd frontend && npm run build         # Production build

# Database
docker-compose up -d postgres        # Start PostgreSQL
```

---

## Architecture Overview

The application is designed to work offline using an **offline-first sync architecture**:

1. **Frontend** stores all data in IndexedDB for offline access
2. **Sync queue** captures changes when offline
3. **Sync API** (`/api/sync/push`, `/api/sync/pull`) handles bidirectional sync
4. **Conflict resolution** uses timestamp-based and owner-priority strategies

**See `backend/CLAUDE.md` and `frontend/CLAUDE.md` for detailed architecture patterns.**

---

## File Structure

```
budget-planner/
â”œâ”€â”€ backend/              # Go API with Chi router
â”‚   â”œâ”€â”€ cmd/api/         # Main entry point
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ handlers/    # HTTP handlers (10 handlers, 100% test coverage)
â”‚   â”‚   â”œâ”€â”€ models/      # Generated by sqlc
â”‚   â”‚   â””â”€â”€ utils/       # Type conversions
â”‚   â”œâ”€â”€ sql/
â”‚   â”‚   â”œâ”€â”€ schema/      # Database migrations
â”‚   â”‚   â””â”€â”€ queries/     # SQL queries for sqlc
â”‚   â””â”€â”€ CLAUDE.md        # Backend development guide
â”œâ”€â”€ frontend/            # SvelteKit PWA
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib/         # Utilities, DB clients, stores
â”‚   â”‚   â””â”€â”€ routes/      # SvelteKit file-based routing
â”‚   â”œâ”€â”€ static/          # PWA assets
â”‚   â””â”€â”€ CLAUDE.md        # Frontend development guide
â”œâ”€â”€ starting-point.md    # Full project specification
â””â”€â”€ CLAUDE.md            # This file
```

---

## Key Reference Files

- **`starting-point.md`** - Complete project specification (database schema, API endpoints, workflows)
- **`backend/CLAUDE.md`** - Backend development patterns (sqlc, type conversions, testing)
- **`frontend/CLAUDE.md`** - Frontend development patterns (SvelteKit, IndexedDB, PWA)
- **`backend/todo.md`** - Backend implementation status
- **`frontend/todo.md`** - Frontend implementation status & TODO

---

## Current Status

**Backend:** âœ… Complete (100% test coverage - 48/48 tests passing)
- All 10 handlers implemented and tested
- JWT-based authentication (Clerk-compatible)
- sqlc for type-safe database queries

**Frontend:** âš ï¸ ~75% Complete
- Core pages implemented (Budget Overview, Expense Tracker, Bill Payment)
- Transaction Modal with form validation
- IndexedDB client and sync queue infrastructure
- âš ï¸ **Needs:** Backend API integration, month navigation, settings page

---

## Environment Configuration

### Backend (.env)
```bash
DATABASE_URL=postgresql://budgetuser:budgetpass@postgres:5432/budgetdb?sslmode=disable
PORT=8080
CLERK_SECRET_KEY=your_clerk_secret_key
CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

### Frontend (.env)
```bash
PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
PUBLIC_API_URL=http://localhost:8080/api
```

**See `backend/CLAUDE.md` or `frontend/CLAUDE.md` for complete configuration details.**

---

## Development Workflow

### Backend
```bash
cd backend
air                              # Hot reload (watches .go and .sql files)
/home/vscode/go/bin/sqlc generate  # Generate Go code from SQL queries
```

### Frontend
```bash
cd frontend
npm run dev                      # Vite dev server with HMR
npm run check:watch              # Watch mode for type checking
```

---

## Testing

**Backend:**
```bash
cd backend
DATABASE_URL="postgresql://budgetuser:budgetpass@localhost:5432/budgetdb?sslmode=disable" go test ./internal/handlers/ -v
```

**Frontend:**
```bash
cd frontend
npm run check                    # TypeScript type checking
npm run build                    # Production build
```

---

## Common Patterns

### Authentication
1. Frontend uses Clerk SDK for authentication
2. Backend validates JWT tokens via middleware
3. User context attached to requests
4. Clerk user ID stored in `users.clerk_user_id` for lookups

### Migrations
- Numbered migration files: `001_initial_schema.up.sql`
- Run: `migrate -path backend/sql/schema -database "$DATABASE_URL" up`

---

## Important Implementation Notes

- **sqlc query generation:** Write SQL in `.sql` files â†’ `sqlc generate` â†’ Go code in `internal/models/`
- **Type conversions:** Backend uses `pgtype` types - always use helpers from `internal/utils/types.go`
- **Chi router:** Use `chi.URLParam(r, "param")` for path parameters, not `r.PathValue()`
- **Offline-first:** Frontend uses IndexedDB (via `idb` library) for local data persistence
- **PWA:** Service worker registered on app load for offline functionality

---

## WRAP-UP Workflow (Integrated with Beans)

When you mention the keyword **"WRAP-UP"**, I will:

### 0. Run Beans Prime (Automatic)

Run `beans prime` to automatically:
- Query recent work and context
- Prepare bean creation/update
- Track files modified in session
- Identify technical debts introduced

### 1. Create/Update Beans for Session Work

**For each feature/bug completed:**
- Create new bean or update existing open bean
- Set status to `completed` with completion date
- Add labels: `[completed]`, `[frontend|backend]`, feature area
- Populate `files_modified` list in bean body
- Add session date in bean body
- Link related beans (dependencies, blockers)

**For technical debts discovered:**
- Create `bug` type bean for technical debt
- Set priority (normal/low based on impact)
- Document problem and workaround used
- Add `files_modified` if applicable
- Add session date in bean body

**âš ï¸ CRITICAL: Log ALL warnings, errors, and workarounds encountered:**
- **Every warning** from type checking, linting, or build tools must have a bean created
- **Every workaround** used to bypass an issue must be documented in a bean
- **Every error** encountered (even if resolved) must be tracked with context
- Include in bean body:
  - Warning/error message text
  - File and line number where it occurred
  - Impact on functionality (critical/normal/low)
  - Workaround or solution applied
  - Future fix recommendations
- This ensures no technical debt is lost and all issues are trackable

**For bugs fixed:**
- Create `bug` type bean with status `completed`
- Document bug description and fix
- Link to feature bean if applicable

### 2. Update CLAUDE.md (If Applicable)

**When to update:**
- New architectural patterns introduced
- New development workflow established
- Breaking changes to existing patterns
- New dependencies or major tech stack changes

**When NOT to update:**
- Routine bug fixes
- Feature implementations following existing patterns
- Test updates
- Beans now tracks progress automatically

### 3. Check .gitignore for Security Files

**Verify these patterns are in .gitignore:**
- `.env*` (all environment files)
- `*.key`, `*.pem`, `*.crt`, `*.p12`, `*.pfx` (certificates/keys)
- `secrets/`, `config/secrets/`, `auth/secrets/` (secrets directories)
- `credentials.json`, `auth.json`, `credentials.yaml` (credentials files)
- `*_secret`, `*.secret` (files with "secret" in name)
- `clerk_*.key` (Clerk-specific keys)
- `.env.production` (production environment)

**Check for files created during session:**
- Any `.env` files created
- Any API key files generated
- Any certificate/key files created
- Any credential files generated

### 4. Commit and Push Changes

**Commit message format (enhanced with Beans):**
```
{type}: {title}

- Bean: {bean_id}
- Session: {session_date}
- Files: {files_modified}

Co-authored-by: Claude Sonnet <noreply@anthropic.com>
```

**Example:**
```
feat(frontend): implement month navigation

- Bean: BP-mfu9
- Session: 2025-12-28
- Files: frontend/src/routes/+layout.svelte, frontend/src/lib/stores/budgets.ts

- Implemented prev/next month buttons
- Updated currentMonth store
- Added data reload on month change

Co-authored-by: Claude Sonnet <noreply@anthropic.com>
```

**Steps:**
1. `beans prime` - Review beans created/updated
2. `git add` all changed files
3. Show brief summary: beans created/updated + files changed + commit message
4. `git commit` with bean-enhanced message
5. `git push` to current branch
6. Display commit SHA for reference

**Note:** This will be automatic after showing the summary (no confirmation needed per user preference).

---

### WRAP-UP Example Session

**User says:** "WRAP-UP"

**I will:**

1. **Run `beans prime`** and review beans:
   ```
   âœ… Created BP-mfu9: Month Navigation (feature, completed)
   âœ… Updated BP-577b: Shadcn CLI workaround (bug, notes added)
   âœ… Created BP-xxxx: Loading States Bug (bug, completed)
   âš ï¸ Created BP-zyuo: CustomModal Accessibility Warnings (bug, low priority)
      - Warning: Elements with 'dialog' role need tabindex value
      - Warning: Click event handler needs keyboard event handler
      - Workaround: Documented for future fix
   âš ï¸ Created BP-c2zk: tailwind-variants TypeScript Issue (bug, low priority)
      - Issue: Type errors when passing className to tv()
      - Workaround: Used string concatenation instead
      - Files: spinner.svelte, skeleton.svelte
   ```

2. **Check context:** "You were working in `frontend/src/routes/+layout.svelte`"

3. **Verify `.gitignore`:**
   - âœ… `.env` already ignored
   - âœ… `*.key` already ignored
   - âœ… No new security files created

4. **Commit with bean metadata:**
   ```bash
   git add .
   git commit -m "feat(frontend): implement month navigation

   - Bean: BP-mfu9
   - Session: 2025-12-28

   Co-authored-by: Claude Sonnet <noreply@anthropic.com>"
   git push origin iteration/1
   ```

---

### Important Notes

**Bean Creation Rules:**

*When to create beans:*
- âœ… Every feature/bug fix/enhancement completed
- âœ… Every technical debt discovered
- âœ… Every testing task completed
- âœ… Every documentation update
- âœ… **EVERY warning, error, or workaround encountered** (CRITICAL - see WRAP-UP workflow)

*Bean metadata requirements:*
- `title` - Clear, actionable title
- `type` - One of: feature, bug, task, milestone, epic
- `status` - todo, in-progress, completed
- `priority` - critical, high, normal, low, deferred
- `tags` - At minimum: [frontend|backend], [feature-area]
- `body` - Include effort estimate, files modified, session date

*Technical Debt beans:*
- Always create when workaround used
- Include problem description
- Include workaround details
- Suggest proper solution if known
- Set priority based on impact

**Useful Beans Commands:**

```bash
# Show open beans by priority
beans list --status todo

# Show frontend tasks
beans list --tag frontend

# Show technical debts
beans list --tag tech-debt

# Start working on a bean
beans update <bean-id> --status in-progress

# Complete a bean
beans update <bean-id> --status completed

# Archive old beans
beans archive
```

**Security Checks - Always verify:**
- No `.env` files committed
- No API keys in code
- No certificates/keys in repository
- No credentials in config files
- Production secrets not in dev commits

---

## KICK-START Workflow

When you mention the keyword **"KICK-START"**, I will:

### 1. Run Beans Prime

Run `beans prime` to get latest context from Beans system and prepare for the session.

### 2. Show Session Context

Display:
- Most recent commit with bean metadata (from WRAP-UP)
- Last beans completed/updated
- Session date from commit message
- Time since last session

### 3. Show Open Tasks by Priority

Group tasks by priority with visual indicators:

**ğŸ”´ CRITICAL** - Must do now (blocks release or essential functionality)
- Bean ID and title
- Type and priority
- Effort estimate
- Tags (frontend/backend, feature area)
- Brief description

**ğŸŸ  HIGH** - Important but not blocking
**ğŸŸ¡ NORMAL** - Standard priority tasks
**ğŸŸ¢ LOW** - Nice to have, can defer

Include:
- Bean ID (e.g., BP-r94p)
- Title
- Type (feature/bug/task)
- Effort estimate
- Tags
- Dependencies (if any)

### 4. Check Git Status

Show:
- Uncommitted changes?
- Untracked files?
- Current branch
- Branch status (ahead/behind origin)
- Last commit summary

### 5. Show Recent Activity

- Last 3 commits with bean IDs
- Beans completed in last session
- Recently updated beans
- Session history

### 6. Suggest Next Steps

Recommend based on:
- Priority (critical first)
- Dependencies (blocking tasks)
- Context (what was just completed)
- Quick wins (low effort, high value)

Top 3 tasks to work on next.

### 7. Check Environment (Optional)

Verify:
- PostgreSQL running (`docker ps`)
- Backend ready (`cd backend`, check `air` status)
- Frontend ready (`cd frontend`, check dev server)

---

### KICK-START Example Session

**User says:** "KICK-START"

**I will:**

1. **Run `beans prime`** and gather context

2. **Display session context:**
   ```
   ğŸš€ KICK-START: Budget Planner Development Session
   =================================================

   ğŸ“… Last Session: 2025-12-28
   âœ… Completed: BP-0g0d - Backend Complete: All 10 Handlers (archived)
   ```

3. **Show open tasks by priority:**
   ```
   ğŸ”´ CRITICAL TASKS (2):
   ==================
   1. BP-r94p: Backend API Integration
      - Type: feature | Priority: critical
      - Effort: 3 hours
      - Tags: frontend, api, sync, backend
      - Wire up actual API calls to Go backend for all CRUD operations

   2. BP-mmy2: Mark Bill Paid Functionality
      - Type: feature | Priority: critical
      - Effort: 30 min
      - Tags: frontend, ui
      - Implement mark bill paid button in bills page

   ğŸŸ  HIGH PRIORITY TASKS (2):
   ==========================
   3. BP-mfu9: Month Navigation (30 min)
   4. BP-7v89: Settings Page (1 hour)

   ğŸŸ¡ NORMAL PRIORITY TASKS (4):
   =============================
   5. BP-8fwz: Loading States (1 hour)
   6. BP-0mr6: Error Handling (1 hour)
   7. BP-577b: Shadcn-Svelte CLI Unavailable (tech-debt, 2 hours)
   8. BP-8qmq: TypeScript Type Definition Simplification (tech-debt, 2 hours)

   ğŸŸ¢ LOW PRIORITY TASKS (2):
   =========================
   9. BP-7k0g: Analytics/Insights Page (2 hours)
   10. BP-kocv: PWA Icons Generation (30 min)
   ```

4. **Check git status:**
   ```
   ğŸ“‚ Git Status:
   ============
   âœ… No uncommitted changes
   âœ… On branch: iteration/1
   âœ… Up to date with origin
   ```

5. **Show recent activity:**
   ```
   ğŸ“ Recent Activity:
   ==================
   2bfc532 feat: migrate from todo.md to Beans task management system
   5574f32 docs: optimize CLAUDE.md files and add WRAP-UP workflow
   dfc8bb0 test: achieve 100% test coverage (48/48 tests passing)
   ```

6. **Suggest next steps:**
   ```
   ğŸ’¡ Suggested Next Steps:
   ========================
   1. Start with BP-r94p (Backend API Integration)
      â†’ Critical priority, blocks other tasks
      â†’ Requires: Backend integration, JWT tokens, error handling

   2. Then BP-mmy2 (Mark Bill Paid)
      â†’ Quick win (30 min)
      â†’ Builds on BP-r94p

   3. Consider BP-577b (tech-debt)
      â†’ May affect BP-r94p implementation
   ```

7. **Check environment (optional):**
   ```
   ğŸ”§ Environment Check:
   ===================
   âš ï¸  PostgreSQL not running
      Start with: docker-compose up -d postgres

   âœ… Frontend dev server ready
      Run: cd frontend && npm run dev

   âœ… Backend hot reload ready
      Run: cd backend && air
   ```

8. **Ask user:**
   ```
   Ready to code! Which task would you like to work on?
   - Enter bean ID (e.g., BP-r94p)
   - Or describe what you'd like to do
   ```

---

### KICK-START vs WRAP-UP

| Aspect | KICK-START | WRAP-UP |
|--------|-----------|---------|
| **Purpose** | Begin session | End session |
| **Timing** | Start of work | End of work |
| **Beans Action** | Query/list beans | Create/update beans |
| **Git Action** | Check status | Commit changes |
| **Output** | Task list, context | Commit summary |
| **Frequency** | Once per session | Once per session |

**Development Workflow:**
```
KICK-START â†’ [Work on tasks] â†’ WRAP-UP â†’ [Break] â†’ KICK-START â†’ ...
```

---

### Important Notes

**When to use KICK-START:**
- Starting a new development session
- Returning from a break
- Need to quickly get up to speed
- Want to see what to work on next

**What KICK-START provides:**
- Full context from last session
- Prioritized task list
- Git status awareness
- Environment readiness check
- Actionable next steps

**KICK-START is optional** - You can also just ask "What should I work on?" or "Show me the critical tasks"
